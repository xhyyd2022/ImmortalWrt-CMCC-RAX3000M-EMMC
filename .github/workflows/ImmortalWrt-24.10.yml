name: ImmortalWrt-24.10

on:
  repository_dispatch:
    types: [build_firmware]
  # push:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      device_model:
        description: 'é€‰æ‹©ç›®æ ‡è®¾å¤‡å‹å·'
        type: choice
        required: true
        options:
          - cmcc_rax3000m
      upload_bin_dir:
        description: 'ä¸Šä¼  bin ç›®å½•'
        type: boolean
        required: true
        default: true
      upload_packages_dir:
        description: 'ä¸Šä¼  packages ç›®å½•'
        type: boolean
        required: true
        default: false
      upload_all_files:
        description: 'ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬ GPTã€preloaderã€FIPã€recoveryã€sysupgradeï¼‰'
        type: boolean
        required: true
        default: false
      repo_url:
        description: 'æºä»“åº“ URL'
        default: 'https://github.com/immortalwrt/immortalwrt'
        type: choice
        options:
          - 'https://github.com/immortalwrt/immortalwrt'
      repo_branch:
        description: 'æºä»“åº“åˆ†æ”¯'
        default: 'openwrt-24.10'
        type: choice
        options:
          - 'openwrt-24.10'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        default: '24.10.config'
        type: choice
        options:
          - '24.10.config'
      enable_keepalived:
        description: 'é›†æˆkeepalived'
        type: boolean
        required: true
        default: true
      ssh:
        description: 'SSH connection to Actions'
        type: boolean
        required: true
        default: false
      # istore:
      #   description: 'é›†æˆiStoreå•†åº—'
      #   type: boolean
      #   required: true
      #   default: false
      # enable_openclash:
      #   description: 'é›†æˆopenclash'
      #   type: boolean
      #   required: true
      #   default: true
      # enable_wechatpush:
      #   description: 'é›†æˆwechatpush'
      #   type: boolean
      #   required: true
      #   default: true

  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: write
  actions: write

env:
  REPO_URL: ${{ github.event.inputs.repo_url || 'https://github.com/immortalwrt/immortalwrt' }}
  REPO_BRANCH: ${{ github.event.inputs.repo_branch || 'openwrt-24.10' }}
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || '24.10.config' }}
  DIY_P1_SH: scripts/24.10/diy-part1.sh
  DIY_P2_SH: scripts/24.10/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}
  BUILD_COMMIT_MSGS_FILE: ''
  CHECKED_COMMIT_MSGS_FILE: ''
  ENABLE_KEEPALIVED: ${{ github.event.inputs.enable_keepalived || 'true' }}
  ENABLE_OPENCLASH: ${{ github.event.inputs.enable_openclash || 'true' }}
  ENABLE_WECHATPUSH: ${{ github.event.inputs.enable_wechatpush || 'false' }}
  UPLOAD_ALL_FILES: ${{ github.event.inputs.upload_all_files || 'false' }}

jobs:
  check-source-updates:
    runs-on: ubuntu-22.04
    name: æ£€æµ‹æºç æ›´æ–°
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      latest_commit_message: ${{ steps.check.outputs.LATEST_COMMIT_MESSAGE }}
    steps:
      - name: æ£€å‡ºæœ¬ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® REPO_PATH
        run: echo "REPO_PATH=$(echo $REPO_URL | sed -E 's#https://github.com/##;s#/$##')" >> $GITHUB_ENV

      - name: è·å–ä¸Šæ¬¡æºä»“åº“æ£€æŸ¥å“ˆå¸Œç¼“å­˜
        id: cache-sha
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      - name: å®‰è£… GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: æ£€æŸ¥æºä»“åº“æ›´æ–°
        id: check
        continue-on-error: true
        run: |
          echo "REPO_PATH=$REPO_PATH"
          echo "REPO_BRANCH=$REPO_BRANCH"

          API_URL="https://api.github.com/repos/${REPO_PATH}/commits/${REPO_BRANCH}"

          echo ">>> è¯·æ±‚ API: $API_URL"

          RAW=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$API_URL")

          # åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆ JSON
          if ! echo "$RAW" | jq empty >/dev/null 2>&1; then
            echo "âŒ GitHub API è¿”å›é JSONï¼ˆå¯èƒ½æ˜¯ rate limit / abuse detectionï¼‰"
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LATEST_SHA=$(echo "$RAW" | jq -r '.sha')
          LATEST_MSG=$(echo "$RAW" | jq -r '.commit.message')

          if [ -z "$LATEST_SHA" ] || [ "$LATEST_SHA" = "null" ]; then
            echo "âŒ æ— æ³•è§£æ SHAï¼Œè·³è¿‡ç¼–è¯‘"
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "æœ€æ–° SHA: $LATEST_SHA"
          echo "æœ€æ–°æäº¤ä¿¡æ¯: $LATEST_MSG"

          LAST_CHECKED_SHA=$(cat last_checked_sha.txt 2>/dev/null || echo "")

          if [ "$LATEST_SHA" != "$LAST_CHECKED_SHA" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "$LATEST_SHA" > last_checked_sha.txt
            echo "LATEST_COMMIT_MESSAGE<<EOF" >> $GITHUB_OUTPUT
            echo "$LATEST_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-source-updates
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.check-source-updates.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    name: ç¼–è¯‘ ${{ github.event.inputs.device_model || 'cmcc_rax3000m' }}
    steps:
      - name: è°ƒè¯•ä¿¡æ¯
        run: |
          DEVICE="${{ github.event.inputs.device_model || 'cmcc_rax3000m' }}"
          echo "DEVICE_MODEL=$DEVICE" >> $GITHUB_ENV
          echo "DEVICE_NAME=_$DEVICE" >> $GITHUB_ENV
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "EVENT_TRIGGER_METHOD=${{ github.event_name }}" >> $GITHUB_ENV
          echo "è®¾å¤‡å‹å·: $DEVICE"
          echo "ä¸Šä¼  bin ç›®å½•: ${{ github.event.inputs.upload_bin_dir }}"
          echo "ä¸Šä¼  packages ç›®å½•: ${{ github.event.inputs.upload_packages_dir }}"

      - name: æ‰©å¤§ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@v10
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true
          root-reserve-mb: 512

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          # æ¸…ç†é¢„è£…è½¯ä»¶
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL >/dev/null 2>&1

          # æ¸…ç† Docker
          sudo systemctl stop docker >/dev/null 2>&1 || true
          sudo rm -rf /var/lib/docker >/dev/null 2>&1

          # æ¸…ç† APT ç¼“å­˜
          sudo apt-get clean >/dev/null 2>&1
          sudo apt-get autoremove -y >/dev/null 2>&1

          # æ¸…ç†å¤§æ–‡ä»¶
          sudo rm -rf /usr/local/share/powershell >/dev/null 2>&1
          sudo rm -rf /usr/local/share/chromium >/dev/null 2>&1
          sudo rm -rf /usr/local/share/edge >/dev/null 2>&1

          # æ¸…ç†æ—¥å¿—
          sudo rm -rf /var/log/* >/dev/null 2>&1

          echo ">>> å½“å‰ç£ç›˜ç©ºé—´"
          df -hT

      - name: è¾“å‡ºæœ€è¿‘çš„ 5 æ¡æäº¤æ—¥å¿—
        run: git log -n 5

      - name: è®¾ç½® REPO_PATH
        run: echo "REPO_PATH=$(echo $REPO_URL | sed -E 's#https://github.com/##;s#/$##')" >> $GITHUB_ENV

      - name: è·å–ä¸Šæ¬¡æœ¬ä»“åº“å“ˆå¸Œç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_build_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha

      - name: è·å–ä¸Šæ¬¡æºä»“åº“å“ˆå¸Œç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      - name: è®¾ç½®æœ€æ–°æäº¤ä¿¡æ¯
        run: |
          if [ -f last_build_sha.txt ]; then
            LAST_BUILD_SHA=$(cat last_build_sha.txt)
            echo "è¯»å–åˆ°ä¸Šæ¬¡æäº¤ SHA: $LAST_BUILD_SHA"
          else
            LAST_BUILD_SHA=""
            echo "æœªæ‰¾åˆ° last_build_sha.txtï¼Œè§†ä¸ºé¦–æ¬¡æ„å»º"
          fi

          # åˆ›å»ºæäº¤æ–‡ä»¶
          TEMP_FILE="$GITHUB_WORKSPACE/build_commit_msgs.txt"

          # å¦‚æœæ˜¯é¦–æ¬¡æ„å»ºï¼Œè¾“å‡ºå…¨éƒ¨æäº¤
          if [ -z "$LAST_BUILD_SHA" ]; then
            echo "é¦–æ¬¡æ„å»ºï¼Œè¾“å‡ºå…¨éƒ¨æäº¤æ—¥å¿—"
            git log --pretty=format:"%s" | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
          else
            # è¾“å‡ºä»ä¸Šæ¬¡æ„å»ºåˆ°ç°åœ¨çš„æäº¤
            git log $LAST_BUILD_SHA..HEAD --pretty=format:"%s" | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
          fi

          # åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "$TEMP_FILE" ]; then
            echo "æœ¬ä»“åº“æ— æ›´æ–°"
          else
            echo "æœ¬ä»“åº“æ›´æ–°ä¿¡æ¯:"
            cat "$TEMP_FILE"
          fi

          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "BUILD_COMMIT_MSGS_FILE=$TEMP_FILE" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          MIN_SPACE=10
          AVAILABLE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
          if [ -z "$AVAILABLE" ] || [ "$AVAILABLE" -lt "$MIN_SPACE" ]; then
            echo "é”™è¯¯ï¼šç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¯ç”¨ç©ºé—´ ${AVAILABLE}Gï¼Œéœ€è‡³å°‘ ${MIN_SPACE}G"
            exit 1
          fi
          echo "å¯ç”¨ç£ç›˜ç©ºé—´ï¼š${AVAILABLE}G"

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL >/dev/null 2>&1
          sudo docker image prune --all --force >/dev/null 2>&1 || true

          sudo apt-get update -qq

          sudo apt-get install -y -qq \
            build-essential ccache cmake curl git gawk gcc-multilib g++-multilib \
            libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
            libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
            ninja-build python3 python3-pyelftools rsync unzip vim wget zlib1g-dev gh help2man \
            flex bison patch gettext lib32gcc-s1 libc6-dev-i386 libncurses-dev

          sudo timedatectl set-timezone "$TZ" >/dev/null 2>&1
          sudo mkdir -p "$GITHUB_WORKSPACE/workdir"
          sudo chown "$USER:$GROUPS" "$GITHUB_WORKSPACE/workdir"

          # ä½¿ç”¨ccache
          mkdir -p ~/.cache/ccache
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          echo "CCACHE=1" >> $GITHUB_ENV

      - name: æ‰©å®¹ /tmp åˆ° 4GB
        run: |
          # å¦‚æœ /tmp æœ¬èº«å°±æ˜¯ tmpfsï¼Œå®ƒä¼šè°ƒæ•´å¤§å°ï¼›å¦‚æœä¸æ˜¯ï¼Œå®ƒä¼šæŒ‚è½½ä¸€ä¸ªæ–°çš„
          sudo mount -t tmpfs -o remount,size=4G /tmp || sudo mount -t tmpfs -o size=4G tmpfs /tmp
          echo ">>> /tmp æ‰©å®¹å®Œæˆ"
          df -hT /tmp

      - name: å…‹éš†æºç 
        working-directory: ${{ github.workspace }}/workdir
        run: |
          if [ -d "${{ github.workspace }}/workdir/openwrt" ]; then
            echo "æ£€æµ‹åˆ° openwrt ç›®å½•å·²å­˜åœ¨ï¼Œæ­£åœ¨æ¸…ç†..."
            rm -rf "${{ github.workspace }}/workdir/openwrt"
          fi

          for i in {1..3}; do
            git clone $REPO_URL -b $REPO_BRANCH openwrt && break
            echo "å…‹éš†å¤±è´¥ï¼Œé‡è¯• $i/3"
            sleep 5
          done

          if [ ! -d "${{ github.workspace }}/workdir/openwrt" ]; then
            echo "é”™è¯¯ï¼šæºç å…‹éš†å¤±è´¥"
            exit 1
          fi

          ln -sf "${{ github.workspace }}/workdir/openwrt" "${{ github.workspace }}/openwrt"

      - name: æ¢å¤ ccache ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ env.DEVICE_MODEL }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            ccache-${{ env.DEVICE_MODEL }}-

      - name: è·å–æºç æäº¤ SHA
        run: |
          if [ -f last_checked_sha.txt ]; then
            LAST_CHECKED_SHA=$(cat last_checked_sha.txt)
            echo "è¯»å–åˆ°ä¸Šæ¬¡æäº¤ SHA: $LAST_CHECKED_SHA"
          else
            LAST_CHECKED_SHA=""
            echo "æœªæ‰¾åˆ° last_checked_sha.txtï¼Œè§†ä¸ºé¦–æ¬¡æ£€æŸ¥"
          fi

          cd "$GITHUB_WORKSPACE/workdir/openwrt"

          TEMP_FILE="$GITHUB_WORKSPACE/checked_commit_msgs.txt"

          # åˆ¤æ–­æ˜¯å¦é¦–æ¬¡è¿è¡Œ
          if [ -z "$LAST_CHECKED_SHA" ]; then
            echo "é¦–æ¬¡è¿è¡Œï¼Œæ— å†å²æ›´æ–°è®°å½•"
          else
            echo "è¾“å‡ºä» $LAST_CHECKED_SHA åˆ° HEAD çš„æäº¤æ—¥å¿—"
            git log $LAST_CHECKED_SHA..HEAD --pretty=format:"%s" \
              | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
          fi

          # åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "$TEMP_FILE" ]; then
            echo "æºä»“åº“æ— æ›´æ–°"
          else
            echo "æºä»“åº“æ›´æ–°ä¿¡æ¯:"
            cat "$TEMP_FILE"
          fi

          # å†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CHECKED_COMMIT_MSGS_FILE=$TEMP_FILE" >> $GITHUB_ENV

          echo "è¾“å‡ºæºä»“åº“æœ€è¿‘çš„ 5 æ¡æäº¤æ—¥å¿—"
          git log -n 5

          echo "å­˜å…¥æºä»“åº“æœ€æ–°æäº¤ä¿¡æ¯åˆ°æ–‡ä»¶"
          echo "$(git rev-parse HEAD)" > "$GITHUB_WORKSPACE/workdir/last_checked_sha.txt"

          # è·å–å½“å‰æºç  SHA
          CURRENT_SHA=$(git rev-parse HEAD)
          COMMIT_URL="${REPO_URL}/commit/${CURRENT_SHA}"
          echo "å½“å‰æºç æäº¤é“¾æ¥: $COMMIT_URL"

          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "SOURCE_COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV
          echo "LATEST_SHA=$CURRENT_SHA" >> $GITHUB_ENV

      - name: ç§»åŠ¨æºä»“åº“å“ˆå¸Œç¼“å­˜åˆ°æ ¹ç›®å½•
        run: |
          mv "$GITHUB_WORKSPACE/workdir/last_checked_sha.txt" ./last_checked_sha.txt
          cat last_checked_sha.txt

      - name: åŠ è½½ Feeds
        timeout-minutes: 10
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: æ›´æ–° Feeds
        timeout-minutes: 30
        run: |
          cd openwrt
          ./scripts/feeds update -a >feeds_update.log 2>&1 || {
            echo "âŒ æ›´æ–° Feeds å¤±è´¥"
            tail -n 50 feeds_update.log
            exit 1
          }
          ./scripts/feeds install -a >feeds_install.log 2>&1 || {
            echo "âŒ å®‰è£… Feeds å¤±è´¥"
            tail -n 50 feeds_install.log
            exit 1
          }

      - name: å®‰è£…iStoreå•†åº—
        if: (github.event.inputs.istore == 'true')
        run: |
          cd openwrt
          echo >> feeds.conf.default
          echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
          ./scripts/feeds update istore
          ./scripts/feeds install -d y -p istore luci-app-store

      - name: åŠ è½½é…ç½®
        run: |
          # å®šä¹‰æ³¨å…¥å‡½æ•°
          inject_config() {
            local file="$1"
            [ ! -f "$file" ] && { echo ">>> è­¦å‘Š: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $file"; return; }
            echo ">>> æ­£åœ¨ä» $file æ³¨å…¥é…ç½®..."
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^# ]] && continue
              opt=$(echo "$line" | cut -d= -f1)
              val=$(echo "$line" | cut -d= -f2)
              sed -i "/^$opt=/d" .config
              echo "$opt=$val" >> .config
            done < "$file"
          }

          # åŸºç¡€æ–‡ä»¶ç§»åŠ¨
          [ -e files ] && mv files openwrt/files
          [ -e config/$CONFIG_FILE ] && cp config/$CONFIG_FILE openwrt/.config

          cd openwrt

          # æ³¨å…¥ç›®æ ‡è®¾å¤‡å‹å·
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_$DEVICE_MODEL=y" >> .config

          # æ‰§è¡Œ DIY Part2 è„šæœ¬
          chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
          $GITHUB_WORKSPACE/$DIY_P2_SH

          # æ³¨å…¥åŠŸèƒ½æ’ä»¶é…ç½®
          [ "$ENABLE_OPENCLASH" = "true" ] && inject_config "$GITHUB_WORKSPACE/config/openclash.config"
          [ "$ENABLE_WECHATPUSH" = "true" ] && inject_config "$GITHUB_WORKSPACE/config/wechatpush.config"
          [ "$ENABLE_KEEPALIVED" = "true" ] && inject_config "$GITHUB_WORKSPACE/config/keepalived.config"

          # ç¦ç”¨ Rust
          inject_config "$GITHUB_WORKSPACE/config/rust_disable.config"

      - name: åˆ†åŒºè¡¨ä¿®æ”¹
        run: |
          cd $GITHUB_WORKSPACE/openwrt
          ls -l target/linux/mediatek/image
          sed -i '/Device\/cmcc_rax3000m_common/,/endef/ s/IMAGE_SIZE := .*/IMAGE_SIZE := 59600m/' \
            target/linux/mediatek/image/filogic.mk

          echo "=== ä¿®æ”¹åçš„é…ç½® ==="
          sed -n '/define Device\/cmcc_rax3000m_common/,/endef/p' \
            target/linux/mediatek/image/filogic.mk

      - name: æ·»åŠ  keepalived-ha æ’ä»¶
        if: env.ENABLE_KEEPALIVED == 'true'
        run: |
          cd openwrt
          git clone --depth=1 https://github.com/PlanetEditorX/luci-app-build.git
          mkdir -p package/luci-app-keepalived-ha
          cp -r luci-app-build/luci-app-keepalived-ha/* package/luci-app-keepalived-ha/
          echo ">>> æ£€æŸ¥ keepalived-ha æ˜¯å¦å¯ç”¨ï¼š"
          grep luci-app-keepalived-ha .config || echo "âŒ keepalived-ha æœªå¯ç”¨"

      - name: ç”Ÿæˆç¼–è¯‘é…ç½®
        run: |
          cd openwrt
          make defconfig

      - name: ä¸‹è½½æºç åŒ…
        run: |
          cd openwrt
          make download -j$(nproc)

      - name: è·å–ç£ç›˜å¢é•¿ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: openwrt/disk_growth.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-disk_growth

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo "ğŸš€ æ­£åœ¨ç¼–è¯‘å›ºä»¶..."
          # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
          : > build.log
          # -------------------------
          # ç£ç›˜å¢é•¿ç¼“å­˜
          # -------------------------
          # é»˜è®¤æœ€å¤§å¢é•¿ï¼ˆ35GBï¼‰
          DEFAULT_MAX=$((35 * 1024 * 1024 * 1024))
          if [ -f disk_growth.txt ]; then
            MAX_GROWTH=$(cat disk_growth.txt)
            echo "ğŸ“ å·²åŠ è½½å†å²ç£ç›˜å¢é•¿å€¼ï¼š$(echo $((MAX_GROWTH/1024/1024/1024))) GB"
          else
            MAX_GROWTH=$DEFAULT_MAX
            echo "ğŸ“ æœªæ‰¾åˆ°å†å²ç¼“å­˜ï¼Œä½¿ç”¨é»˜è®¤æœ€å¤§å¢é•¿ï¼š35GB"
          fi

          # è®°å½•åˆå§‹ç£ç›˜å ç”¨
          START=$(df -B1 "${GITHUB_WORKSPACE}" | awk 'NR==2{print $3}')
          # -------------------------
          # å¯åŠ¨åå°ç›‘æ§ï¼ˆåŒå¾ªç¯ï¼‰
          # -------------------------
          (
            RUNTIME_MAX=$MAX_GROWTH
            LAST_OUTPUT_TIME=$(date +%s)
            INTERVAL=300
            # é¢œè‰²å®šä¹‰
            RED="\033[31m"
            GREEN="\033[32m"
            YELLOW="\033[33m"
            BLUE="\033[34m"
            MAGENTA="\033[35m"
            CYAN="\033[36m"
            RESET="\033[0m"
            # äº‹ä»¶å¾ªç¯ï¼šç›‘å¬ build.log
            tail -F build.log 2>/dev/null | while read -r LINE; do
              echo "$LINE" > /tmp/last_line
            done &
            # -------------------------
            # å¿ƒè·³å¾ªç¯
            # -------------------------
            STAGE="${CYAN}åˆå§‹åŒ–${RESET}"
            while true; do
              NOW=$(date +%s)
              LINE=$(cat /tmp/last_line 2>/dev/null || echo "")
              # -------------------------
              # é˜¶æ®µè¯†åˆ«ï¼ˆæ ¹æ®æ—¥å¿—å†…å®¹ï¼‰
              # -------------------------
              if echo "$LINE" | grep -qE "make\[[0-9]+\].*-C tools/"; then
                STAGE="${CYAN}Tools (10%)${RESET}"
              elif echo "$LINE" | grep -qE "make\[[0-9]+\].*-C toolchain/"; then
                STAGE="${BLUE}Toolchain (25%)${RESET}"
              elif echo "$LINE" | grep -qE "make\[[0-9]+\].*-C target/linux"; then
                STAGE="${MAGENTA}Target (45%)${RESET}"
              elif echo "$LINE" | grep -qE "make\[[0-9]+\].*-C package/"; then
                STAGE="${YELLOW}Package (70%)${RESET}"
              elif echo "$LINE" | grep -qE "make\[[0-9]+\].*-C package/install"; then
                STAGE="${GREEN}Install (90%)${RESET}"
              fi

              # -------------------------
              # ç£ç›˜ç›‘æ§
              # -------------------------
              USED=$(df -B1 "${GITHUB_WORKSPACE}" | awk 'NR==2{print $3}')
              DELTA=$((USED - START))
              if [ $DELTA -gt $RUNTIME_MAX ]; then
                RUNTIME_MAX=$DELTA
              fi
              echo "$RUNTIME_MAX" > /tmp/max_growth_runtime
              # -------------------------
              # å®šæ—¶åˆ·æ–°ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
              # -------------------------
              if [ $((NOW - LAST_OUTPUT_TIME)) -ge $INTERVAL ]; then
                LAST_OUTPUT_TIME=$NOW
                PERCENT=$((DELTA * 100 / RUNTIME_MAX))
                [ $PERCENT -gt 100 ] && PERCENT=100
                echo -e "${MAGENTA}========== â³ å®šæ—¶åˆ·æ–° ($(date '+%H:%M:%S'))  â³ ==========${RESET}"
                echo -e "ğŸ“¦ ç£ç›˜ä¿¡æ¯ï¼š${CYAN}$(df -h "${GITHUB_WORKSPACE}" | awk 'NR==2{print $3 "/" $2 " used (" $5 ")"}')${RESET}"
                echo -e "ğŸ“Š ä¼°ç®—è¿›åº¦ï¼š${YELLOW}${PERCENT}%${RESET}"
                echo -e "ğŸ“Œ å½“å‰é˜¶æ®µï¼š${STAGE}"
                echo "-----------------------------------------"
              fi
              sleep 1
            done
          ) &
          monitor_pid=$!

          # -------------------------
          # æ­£å¼ç¼–è¯‘
          # -------------------------
          stdbuf -oL -eL make -j$(nproc) 2>&1 | stdbuf -oL tee build.log
          RET=${PIPESTATUS[0]}
          kill $monitor_pid || true
          if [ $RET -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
          fi
          # -------------------------
          # è‡ªå­¦ä¹ ç£ç›˜å¢é•¿
          # -------------------------
          if [ -f /tmp/max_growth_runtime ]; then
            MAX_GROWTH=$(cat /tmp/max_growth_runtime)
          fi
          END=$(df -B1 "${GITHUB_WORKSPACE}" | awk 'NR==2{print $3}')
          DELTA=$((END - START))
          THRESHOLD=$((MAX_GROWTH / 100))
          DIFF=$((DELTA - MAX_GROWTH))
          [ $DIFF -lt 0 ] && DIFF=$(( -DIFF ))
          if [ ! -f disk_growth.txt ]; then
            echo "$DELTA" > disk_growth.txt
            echo "ğŸ“ é¦–æ¬¡è¿è¡Œï¼Œå·²åˆå§‹åŒ–ç£ç›˜å¢é•¿ç¼“å­˜ï¼š$(echo $((DELTA/1024/1024/1024))) GB"
          elif [ "$DIFF" -gt "$THRESHOLD" ]; then
            echo "$DELTA" > disk_growth.txt
            echo "ğŸ“ ç£ç›˜å¢é•¿å˜åŒ–è¶…è¿‡ 1%ï¼Œå·²æ›´æ–°ç¼“å­˜ä¸ºï¼š$(echo $((DELTA/1024/1024/1024))) GB"
          else
            echo "ğŸ“ å˜åŒ–æœªè¶…è¿‡ 1%ï¼Œä¸æ›´æ–°ç¼“å­˜"
          fi

          echo "status=success" >> $GITHUB_OUTPUT
          echo "DEVICE_NAME=_$DEVICE_MODEL" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"

      - name: æŸ¥çœ‹ ccache å‘½ä¸­ç‡å’Œç¼“å­˜å¤§å°
        run: |
          echo "=== ccache ç»Ÿè®¡ä¿¡æ¯ ==="
          ccache -s || true

          echo "=== ccache ç›®å½•å¤§å° ==="
          du -sh ~/.cache/ccache || true

      - name: ä¿å­˜ ccache ç¼“å­˜
        if: steps.compile.outputs.status == 'success'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ env.DEVICE_MODEL }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            ccache-${{ env.DEVICE_MODEL }}-

      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compile-log-${{ env.DEVICE_MODEL }}
          path: |
            openwrt/build_dir/**/log/*.log
            openwrt/build_dir/**/*.log
            openwrt/build_dir/**/*.txt
            openwrt/build_dir/**/*.err
            openwrt/build_dir/**/*.out
            openwrt/logs/**
            openwrt/*.log
            openwrt/.config

      - name: æå–å›ºä»¶ç‰ˆæœ¬å·
        id: version
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt
          VERSION=$(git rev-parse --short HEAD || echo "unknown")
          SAFE_VERSION="r${VERSION}"
          echo "æå–çš„ç‰ˆæœ¬å·: $SAFE_VERSION"
          echo "FIRMWARE_VERSION=$SAFE_VERSION" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ç£ç›˜
        if: always()
        run: |
          df -hT

      - name: æ•´ç†å›ºä»¶å¹¶å›ºå®šæ–‡ä»¶å
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          set -e

          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          echo "ğŸ“‚ åˆ—å‡º openwrt/bin ç›®å½•ï¼š"
          ls -al openwrt/bin || echo "âŒ openwrt/bin ä¸å­˜åœ¨"

          echo "ğŸ“‚ åˆ—å‡º openwrt/bin/targetsï¼š"
          ls -al openwrt/bin/targets || echo "âŒ openwrt/bin/targets ä¸å­˜åœ¨"

          echo "ğŸ“‚ æ·±åº¦åˆ—å‡º targets ç›®å½•ç»“æ„ï¼š"
          find openwrt/bin/targets -maxdepth 4 -type d 2>/dev/null || echo "âŒ æœªæ‰¾åˆ°ä»»ä½• targets å­ç›®å½•"

          # æ‰¾åˆ°å›ºä»¶ç›®å½•ï¼ˆæ›´ç¨³ï¼‰
          TARGET_DIR=$(find openwrt/bin/targets -type d -mindepth 2 -maxdepth 4 | head -n 1 || true)

          if [ -z "$TARGET_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ° openwrt/bin/targets ä¸‹çš„å›ºä»¶ç›®å½•ï¼Œå¯èƒ½æœ¬æ¬¡æœªç”Ÿæˆå›ºä»¶"
            exit 1
          fi

          echo "ğŸ“ è¿›å…¥å›ºä»¶ç›®å½•ï¼š$TARGET_DIR"
          cd "$TARGET_DIR"

          # ç§»åŠ¨ packages
          [ -d packages ] && mv packages "$GITHUB_WORKSPACE"

          echo "ğŸ“‚ å›ºä»¶ç›®å½•å†…å®¹ï¼š"
          ls -la

          DEVICE_MODEL="${DEVICE_MODEL:-rax3000m}"

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å›ºä»¶æ–‡ä»¶
          FW_COUNT=$(ls *sysupgrade* *factory* 2>/dev/null | wc -l || true)

          if [ "$FW_COUNT" -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ° sysupgrade æˆ– factory å›ºä»¶æ–‡ä»¶ï¼Œæ— æ³•é‡å‘½å"
            exit 1
          fi

          # é‡å‘½åå›ºä»¶
          for file in *sysupgrade* *factory*; do
            if [ -f "$file" ] && ! echo "$file" | grep -q -- "-bl2"; then
              TYPE=$(echo "$file" | grep -o "sysupgrade\|factory")
              EXT="${file##*.}"
              NEW_NAME="${DEVICE_MODEL}_${FIRMWARE_VERSION}${FILE_DATE}_${TYPE}.${EXT}"
              echo "ğŸ”§ é‡å‘½åï¼š$file â†’ $NEW_NAME"
              mv "$file" "$NEW_NAME"
            fi
          done

          echo "FIRMWARE=$PWD" >> "$GITHUB_ENV"
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "ğŸ‰ å›ºä»¶æ•´ç†å®Œæˆ"

      - name: ä¸Šä¼  bin
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && github.event_name == 'workflow_dispatch' && github.event.inputs.upload_bin_dir == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: ä¸Šä¼  packages
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && github.event_name == 'workflow_dispatch' && github.event.inputs.upload_packages_dir == 'true'
        with:
          name: OpenWrt_packages${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ github.workspace }}/packages

      - name: ç”Ÿæˆæ ‡ç­¾å’Œå‘å¸ƒæè¿°
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          set -e
          # éªŒè¯å¿…è¦å˜é‡
          if [ -z "$DEVICE_MODEL" ] || [ -z "${{ env.FIRMWARE_VERSION }}" ]; then
            echo "Missing required variables"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ›´æ–°
          [ -s "$BUILD_COMMIT_MSGS_FILE" ] && echo ">>> æœ¬ä»“åº“å­˜åœ¨æ›´æ–°"
          [ -s "$CHECKED_COMMIT_MSGS_FILE" ] && echo ">>> æºä»“åº“å­˜åœ¨æ›´æ–°"

          # ç”Ÿæˆæ ‡ç­¾
          TAG="ImmortalWrt-24.10-$DEVICE_MODEL-${{ env.FIRMWARE_VERSION }}"
          echo "RELEASE_TAG=$TAG-$(date +%Y%m%d%H%M%S)" | tee -a $GITHUB_OUTPUT >> $GITHUB_ENV

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          {
            echo "## ğŸ“¦ å›ºä»¶ä¿¡æ¯"
            echo "å›ºä»¶ç‰ˆæœ¬: ImmortalWrt ${{ env.FIRMWARE_VERSION }}"
            echo "è®¾å¤‡å‹å·: $DEVICE_MODEL"
            echo "ç¼–è¯‘æ—¶é—´: $(date +'%Y-%m-%d %H:%M %Z')"
            echo "åå°åœ°å€: 192.168.2.1 æˆ– http://immortalwrt.lan/"
            echo "æºä»£ç ä»“åº“: $REPO_URL"
            echo "æºä»“åº“åˆ†æ”¯: $REPO_BRANCH"
            echo "æºä»“åº“æäº¤: [æŸ¥çœ‹ç¼–è¯‘æ—¶æäº¤]($SOURCE_COMMIT_URL)"
            echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            echo "è§¦å‘æ–¹å¼: $EVENT_TRIGGER_METHOD"
            if [ -s "$BUILD_COMMIT_MSGS_FILE" ] || [ -s "$CHECKED_COMMIT_MSGS_FILE" ]; then
              echo -e "\n## ğŸ“ æ›´æ–°å†…å®¹"

              # æœ¬ä»“åº“è¾“å‡º
              if [ -s "$BUILD_COMMIT_MSGS_FILE" ]; then
                [ -s "$CHECKED_COMMIT_MSGS_FILE" ] && echo "### ğŸ“Œ æœ¬ä»“åº“æ›´æ–°"
                cat "$BUILD_COMMIT_MSGS_FILE"
              fi

              # æºä»“åº“è¾“å‡º
              if [ -s "$CHECKED_COMMIT_MSGS_FILE" ]; then
                  [ -s "$BUILD_COMMIT_MSGS_FILE" ] && echo "### ğŸ“Œ æºä»“åº“æ›´æ–°"
                  cat "$CHECKED_COMMIT_MSGS_FILE"
              fi
            fi
            echo "## éªŒè¯å›ºä»¶"
            echo "- æœªéªŒè¯"
            echo "## ğŸ”§ åˆ·æœºè¯´æ˜"
            echo "1. ä½¿ç”¨ **sysupgrade.itb** è¿›è¡Œå‡çº§ã€‚"
            echo "2. è‹¥å¯ç”¨äº†â€œä¸Šä¼ æ‰€æœ‰æ–‡ä»¶â€ï¼Œè¯·è°¨æ…ä½¿ç”¨ GPTã€preloaderã€FIP ç­‰æ–‡ä»¶ï¼Œå®ƒä»¬ä»…ç”¨äºåº•å±‚æ¢å¤ã€‚"
            echo "3. å¦‚éœ€æ•‘ç –ï¼Œå¯ä½¿ç”¨ **initramfs-recovery.itb** ä» U-Boot å¯åŠ¨æ¢å¤ç³»ç»Ÿã€‚"
          } > release

          echo "status=success" >> $GITHUB_OUTPUT

      - name: è°ƒè¯•è¾“å‡º
        run: |
          echo "FIRMWAREè·¯å¾„: ${{ env.FIRMWARE }}"
          echo "TAGçŠ¶æ€: ${{ steps.tag.outputs.status }}"
          ls -la ${{ env.FIRMWARE }} || echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨: ${{ env.FIRMWARE }}"

      - name: æ£€æŸ¥ release
        run: |
          ls -l ${{ github.workspace }}/release
          cat ${{ github.workspace }}/release
          if [ ! -s ${{ github.workspace }}/release ]; then
            echo "é”™è¯¯ï¼šrelease æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æ£€æŸ¥ tag æ­¥éª¤è¾“å‡º
        run: |
          echo "tag status: ${{ steps.tag.outputs.status }}"
          echo "RELEASE_TAG: ${{ steps.tag.outputs.RELEASE_TAG }}"
          echo "RELEASE_TAG env: $RELEASE_TAG"

      - name: å‘å¸ƒå›ºä»¶
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
          body_path: release
          files: |
            ${{ env.UPLOAD_ALL_FILES == 'true' && format('{0}/*', env.FIRMWARE) || format('{0}/*sysupgrade*.*', env.FIRMWARE) }}

      - name: éªŒè¯Releaseåˆ›å»º
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN  }}" \
          https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG | jq .
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šRelease åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          echo "Release åˆ›å»ºæˆåŠŸ: $RELEASE_TAG"

      - name: ä¿å­˜æœ¬ä»“åº“å“ˆå¸Œ
        run: |
          echo "$(git rev-parse HEAD)" > last_build_sha.txt

      - name: æ ¡éªŒç¼“å­˜æ–‡ä»¶
        run: |
          echo "æ£€æŸ¥ last_build_sha.txt æ–‡ä»¶å†…å®¹"
          if [ ! -f last_build_sha.txt ]; then
            echo "é”™è¯¯ï¼šlast_build_sha.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          else
            echo "last_build_sha.txt æ–‡ä»¶å­˜åœ¨"
            cat last_build_sha.txt
          fi
          echo "æ£€æŸ¥ last_checked_sha.txt æ–‡ä»¶å†…å®¹"
          if [ ! -f last_checked_sha.txt ]; then
            echo "é”™è¯¯ï¼šlast_checked_sha.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          else
            echo "last_checked_sha.txt æ–‡ä»¶å­˜åœ¨"
            cat last_checked_sha.txt
          fi
          echo "æ£€æŸ¥ disk_growth.txt æ–‡ä»¶å†…å®¹"
          if [ ! -f openwrt/disk_growth.txt ]; then
            echo "é”™è¯¯ï¼šdisk_growth.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          else
            echo "disk_growth.txt æ–‡ä»¶å­˜åœ¨"
            cat openwrt/disk_growth.txt
          fi

      - name: åˆ é™¤æŒ‡å®šç¼“å­˜
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å½“å‰çš„ç¼“å­˜åˆ—è¡¨"
          gh cache list
          gh cache delete "${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha" \
            --repo ${{ github.repository }}
          gh cache delete "${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha" \
            --repo ${{ github.repository }}
          gh cache delete "${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-disk_growth" \
            --repo ${{ github.repository }}
          sleep 5

          PREFIX="ccache-${{ env.DEVICE_MODEL }}-${{ env.REPO_BRANCH }}"
          echo "æ¸…ç†ç¼“å­˜å‰ï¼š"
          gh cache list --json id,key,createdAt | jq -r '.[] | "\(.createdAt) \(.key) \(.id)"'

          # æ‰¾å‡ºæ‰€æœ‰åŒ¹é…çš„ç¼“å­˜ï¼Œåªä¿ç•™æœ€æ–°çš„ç¼“å­˜
          gh cache list --json id,key,createdAt \
            | jq -r '.[] | select(.key | startswith("'"$PREFIX"'")) | "\(.createdAt) \(.id)"' \
            | sort -r \
            | tail -n +2 \
            | awk '{print $2}' \
            | xargs -I {} gh cache delete {}

          gh cache list

      - name: ä¿å­˜æœ¬ä»“åº“å“ˆå¸Œç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_build_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha

      - name: ä¿å­˜æºä»“åº“å“ˆå¸Œç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      - name: ä¿å­˜ç£ç›˜å¢é•¿ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: openwrt/disk_growth.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-disk_growth

      - name: æ¸…ç†æ—§ Releases
        if: steps.tag.outputs.status == 'success'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEVICE_MODEL: ${{ env.DEVICE_MODEL }}
          CURRENT_RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          echo "å½“å‰è®¾å¤‡å‹å·: $DEVICE_MODEL"
          echo "å½“å‰ä¿ç•™ Release: $CURRENT_RELEASE"

          # è·å–ç¬¦åˆå½“å‰å‹å·çš„æ‰€æœ‰ Release åˆ—è¡¨
          # ä¿®æ­£äº†è¿‡æ»¤æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›´æ¥å¼•ç”¨ $DEVICE_MODEL
          RELEASES=$(gh release list --limit 100 --json name --jq ".[] | select(.name | test(\"ImmortalWrt-24.10-$DEVICE_MODEL\")) | .name")

          if [ -n "$RELEASES" ]; then
            for RELEASE in $RELEASES; do
              # ç¡®ä¿ä¸åˆ é™¤åˆšåˆšç”Ÿæˆçš„å½“å‰ Release
              if [ "$RELEASE" = "$CURRENT_RELEASE" ]; then
                echo "ä¿æŒå½“å‰æ–°å‘å¸ƒçš„ Release: $RELEASE"
                continue
              fi
              echo "æ­£åœ¨åˆ é™¤æ—§ Release: $RELEASE"
              gh release delete "$RELEASE" --yes --cleanup-tag || echo "âŒ åˆ é™¤ Release $RELEASE å¤±è´¥ï¼Œè·³è¿‡..."
            done
          else
            echo "æœªå‘ç°è¯¥å‹å·çš„æ—§ Releasesï¼Œæ— éœ€æ¸…ç†"
          fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: rm -f ${{ env.BUILD_COMMIT_MSGS_FILE }} ${{ env.CHECKED_COMMIT_MSGS_FILE }}

      - name: æ¸…ç†æ—§å·¥ä½œæµè¿è¡Œ
        if: steps.tag.outputs.status == 'success'
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 7
          keep_minimum_runs: 2