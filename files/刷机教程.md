> 免责声明：刷机有风险，仅测试的一台CMCC-RAX3000M-EMMC成功，刷前自己考虑是否承担操作不当变砖的风险，会先救砖才刷。

## 刷入过程

1. 上传所有文件到/tmp
2. 流程
   - 刷入GPT分区表：使用dd命令写入自定义分区表
   - 刷入BL2：清空并写入引导加载程序
   - 刷入FIP：清空并写入第二阶段引导程序
3. 在同文件目录下直接执行或创建一键脚本：`flash.sh`
   ```bash
   #!/bin/sh
   # 刷入GPT分区表
   dd if=immortalwrt-mediatek-filogic-cmcc_rax3000m-emmc-gpt.bin of=/dev/mmcblk0 bs=512 seek=0 count=34 conv=fsync

   # 刷入BL2
   echo 0 > /sys/block/mmcblk0boot0/force_ro
   dd if=/dev/zero of=/dev/mmcblk0boot0 bs=512 count=8192 conv=fsync
   dd if=immortalwrt-mediatek-filogic-cmcc_rax3000m-emmc-preloader.bin of=/dev/mmcblk0boot0 bs=512 conv=fsync

   # 刷入FIP
   dd if=/dev/zero of=/dev/mmcblk0 bs=512 seek=13312 count=8192 conv=fsync
   dd if=immortalwrt-mediatek-filogic-cmcc_rax3000m-emmc-bl31-uboot.fip of=/dev/mmcblk0 bs=512 seek=13312 conv=fsync
   ```
4. 执行命令刷入
   ```bash
   chmod +x flash.sh && ./flash
   ```
5. 保险起见可以计算上传后的文件和分区的哈希值，比较哈希值与`sha256sums`里对应的哈希值是否一样，避免传输或刷入异常造成文件损坏。
   ```bash
   #!/bin/sh

   echo "验证 GPT..."
   dd if=/dev/mmcblk0 bs=512 count=34 | sha256sum
   sha256sum immortalwrt-mediatek-filogic-cmcc_rax3000m-emmc-gpt.bin

   echo "验证 BL2..."
   size=$(stat -c%s preloader.bin)
   dd if=/dev/mmcblk0boot0 bs=1 count=$size | sha256sum
   sha256sum immortalwrt-mediatek-filogic-cmcc_rax3000m-emmc-preloader.bin

   echo "验证 FIP..."
   size=$(stat -c%s bl31-uboot.fip)
   dd if=/dev/mmcblk0 bs=1 skip=$((13312*512)) count=$size | sha256sum
   sha256sum immortalwrt-mediatek-filogic-cmcc_rax3000m-emmc-bl31-uboot.fip
   ```
6. 手动配置电脑IP为`192.168.1.254`，`255.255.255.0`，`192.168.1.1`
7. 将`immortalwrt-mediatek-filogic-cmcc_rax3000m-initramfs-recovery.itb`放到到TFTP服务器根目录，或手动选择文件路径，运行`tftpd64.exe`，指定服务接口为设置的电脑网卡。
8. 连接ttl网口朝外分别为GND,TX,VCC,RX，连接USB转TTL线，GND连GND，TX连RX，VCC留空，RX连TX。（可选，查看过程）
   <img width="400" alt="ttl参考图" src="https://github.com/user-attachments/assets/73111e46-a7dc-4434-b1c9-959bbb926a0e" />

   按住reset键重启进入U-Boot，会自动触发向TFTP拉取固件。
   <img width="800" alt="TFTP固件传输" src="https://github.com/user-attachments/assets/fa940079-f701-4c5f-a567-3f8a3763a49b" />
   
   此时如果连接ttl，则会看到刷入过程。
   <img width="800" alt="ttl传输显示" src="https://github.com/user-attachments/assets/7162a44d-3764-4b2c-a719-1a219da653aa" />
   
   现在刷入了运行在内存的临时系统，重启后配置会丢失。
   <img width="800" alt="临时系统" src="https://github.com/user-attachments/assets/c4a40f66-6966-4eda-8c3c-22643a93b0ec" />
   
10. 修改电脑网卡为自动获取IP，访问`192.168.2.1`进入系统
11. 在`系统→备份与更新→更新固件`中，选择`immortalwrt-mediatek-filogic-cmcc_rax3000m-squashfs-sysupgrade.itb`刷入正式系统

---
## AP设置

> 由于只用作AP，只给出AP使用
1. 联网的网线连接任一LAN口，来到`网络→接口`，删除`wan`和`wan6`或关闭`开机自动连接`
2. 修改lan口
   - 常规设置
     - IPv4：`192.168.1.2`（任意局域网IP）
     - IPv4 网关：`192.168.1.100`（主路由）
     - IPv4 广播地址：`192.168.1.255`
   - 高级设置
     - 使用自定义的 DNS 服务器：`192.168.1.100`
   - DHCP服务器
     - 常规设置
       - 忽略此接口：开启
     - 高级设置
     - 动态 DHCP：关闭
3. 保存并应用，从设置的新IP`192.168.1.2`访问页面

---
## 使用空闲空间
1. 查看`系统→挂载点`，当前软件可以总空间为124.14 MiB
2. 安装`fdisk`
   ```bash
   opkg update
   opkg install fdisk
   fdisk -l
   ```
- 输出当前的空间信息，可能细节会不同
  ```bash
  root@ImmortalWrt:~# fdisk -l
  GPT PMBR size mismatch (458783 != 122126335) will be corrected by write.
  The backup GPT table is corrupt, but the primary appears OK, so that will be used.
  The backup GPT table is not on the end of the device.
  Disk /dev/mmcblk0: 58.23 GiB, 62528684032 bytes, 122126336 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes
  Disklabel type: gpt
  Disk identifier: 5455571F-3322-4433-5566-778899AABB00

  Device            Start    End Sectors  Size Type
  /dev/mmcblk0p1     8192   9215    1024  512K Linux filesystem
  /dev/mmcblk0p2     9216  13311    4096    2M Linux filesystem
  /dev/mmcblk0p3    13312  21503    8192    4M EFI System
  /dev/mmcblk0p4    24576  90111   65536   32M EFI System
  /dev/mmcblk0p5   131072 458751  327680  160M unknown
  /dev/mmcblk0p128     34   8191    8158    4M BIOS boot

  Partition table entries are not in disk order.

  Disk /dev/mmcblk0boot0: 4 MiB, 4194304 bytes, 8192 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes

  Disk /dev/mmcblk0boot1: 4 MiB, 4194304 bytes, 8192 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes

  Disk /dev/fit0: 28.18 MiB, 29544448 bytes, 57704 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes

  Disk /dev/fitrw: 126.14 MiB, 132263936 bytes, 258328 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes
  ```
- 或安装sgdisk
  ```bash
  opkg update
  opkg install sgdisk gdisk
  sgdisk -p /dev/mmcblk0
  ```
- 输出当前的空间信息，可能细节会不同
  ```bash
  Disk /dev/mmcblk0: 122126336 sectors, 58.2 GiB
  Sector size (logical/physical): 512/512 bytes
  Disk identifier (GUID): 5455571F-3322-4433-5566-778899AABB00
  Partition table holds up to 128 entries
  Main partition table begins at sector 2 and ends at sector 33
  First usable sector is 34, last usable sector is 122126302
  Partitions will be aligned on 2-sector boundaries
  Total free space is 121711583 sectors (58.0 GiB)

  Number  Start (sector)    End (sector)  Size       Code  Name
     1            8192            9215   512.0 KiB   8300  ubootenv
     2            9216           13311   2.0 MiB     8300  factory
     3           13312           21503   4.0 MiB     EF00  fip
     4           24576           90111   32.0 MiB    EF00  recovery
     5          131072          458751   160.0 MiB   FFFF  production
   128              34            8191   4.0 MiB     EF02
  ```

3. 把 GPT 备份表移动到磁盘末尾
   ```bash
   # 安装parted
   opkg install parted
   # 进入parted磁盘管理，每行前方自带(parted)
   parted /dev/mmcblk0
   ```
- 输入`print` → `OK` → `Fix`，对分区表执行修复，`print`输出不报错，就输入`quit`退出
  ```bash
  (parted) print
  Error: The backup GPT table is corrupt, but the primary appears OK, so that will be used.
  OK/Cancel? OK
  Warning: Not all of the space available to /dev/mmcblk0 appears to be used, you can fix the GPT to use all of the space (an extra
  121667551 blocks) or continue with the current setting?
  Fix/Ignore? Fix
  Model: MMC SCA64G (sd/mmc)
  Disk /dev/mmcblk0: 62.5GB
  Sector size (logical/physical): 512B/512B
  Partition Table: gpt
  Disk Flags:

  Number  Start   End     Size    File system  Name        Flags
  128     17.4kB  4194kB  4177kB                           bios_grub
   1      4194kB  4719kB  524kB                ubootenv    hidden, legacy_boot
   2      4719kB  6816kB  2097kB               factory     hidden
   3      6816kB  11.0MB  4194kB               fip         boot, hidden, esp
   4      12.6MB  46.1MB  33.6MB               recovery    boot, hidden, esp
   5      67.1MB  235MB   168MB                production
  ```

4. 创建新分区（从剩余空间开始）
   查看之前输出的p5是`/dev/mmcblk0p5   131072 458751  327680  160M unknown`
   我的剩余空间起点是：
   ```bash
   Start = 458752 (p5的中止458751，p6的起始+1)
   ```

- 创建 p6：
  ```bash
  parted /dev/mmcblk0
  (parted) mkpart primary ext4 458752s 100%
  (parted) quit
  ```
   注：mkpart primary ext4 <起始位置>s <结束位置>，起始位置后面有一个s

- 这会创建：
  ```bash
  /dev/mmcblk0p6   →  58GB ext4 分区
  ```

- 参考
  ```bash
  Number  Start (sector)    End (sector)  Size       Code  Name
     1            8192            9215   512.0 KiB   8300  ubootenv
     2            9216           13311   2.0 MiB     8300  factory
     3           13312           21503   4.0 MiB     EF00  fip
     4           24576           90111   32.0 MiB    EF00  recovery
     5          131072          458751   160.0 MiB   FFFF  production
     6          458752       122124287   58.0 GiB    8300  primary
   128              34            8191   4.0 MiB     EF02
  ```

5. 格式化新分区
   ```bash
   mkfs.f2fs /dev/mmcblk0p6
   ```

- 输出
  ```bash
  root@ImmortalWrt:~# mkfs.f2fs /dev/mmcblk0p6
      F2FS-tools: mkfs.f2fs Ver: 1.16.0 (2023-04-11)
  Info: Disable heap-based policy
  Info: Debug level = 0
  Info: Trim is enabled
  Info: Segments per section = 1
  Info: Sections per zone = 1
  Info: sector size = 512
  Info: total sectors = 121665536 (59407 MB)
  Info: zone aligned segment0 blkaddr: 512
  Info: format version with
    "Linux version 6.6.119 (xiong@ubuntu) (aarch64-openwrt-linux-musl-gcc (OpenWrt GCC 13.3.0 r0-7f14266) 13.3.0, GNU ld (GNU Binutils) 2.42) #0 SMP Tue Jan  6 03:39:23 2026"
  Info: [/dev/mmcblk0p6] Discarding device
  Info: Secure Discarded 0 MB
  Info: Overprovision ratio = 0.600%
  Info: Overprovision segments = 178 (GC reserved = 173)
  Info: format successful
  ```

6. 创建挂载点
   来到`系统→挂载点→添加`，将其作为`/overlay`空间，保存应用后重启系统
   <img width="800" alt="挂载点" src="https://github.com/user-attachments/assets/bd4be6f7-16eb-4806-8453-88b9ddaf29ea" />

8. 现在系统被初始化，空间变大，一切从头开始配置就可以了
   <img width="800" alt="软件包" src="https://github.com/user-attachments/assets/2763fe22-5f43-4d7f-a687-8b3cbf75fa2e" />

   注：之所以开始配置好后不直接备份配置，是因为现在把p6作为/overlay，p5给闲置了，如果一开始备份那时还是p5作为/overlay，恢复配置后/overlay又从p6变回p5。
